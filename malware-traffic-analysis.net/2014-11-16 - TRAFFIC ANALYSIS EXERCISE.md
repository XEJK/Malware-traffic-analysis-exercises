In this writeup I will go trough this exercise:
https://www.malware-traffic-analysis.net/2014/11/16/index.html

The executive summary for this incident is:
    The host K34EN6W3N-PC was infected with malware by visiting a presumably compromised website, looking at the network traffic it seems that no other hosts where infected and no attempts where made to do so.
    However as it seems that the malware was a known variant it might be worthwhile to study best practices concerning endpoint security.


Technical report:
    The user of the host K34EN6W3N-PC was infected with malware by visiting a presumably compromised website ciniholland.nl which redirected to 24corp-shop.com which in turn redirected to the dropper for the exploit kit stand.trustandprobaterealty.com.
    This dropped the exploit files for a JAR and a Flash exploit making use of cve-2012-0507 and cve-2014-0569 respectively
    I also looked to see if there was any SMB, Kerebos or SMTP traffic to see if there was any attempt at spreading the malware or gaining more access to           a corporate network.
    This concludes my report.


Detailed steps:

Seeing as this is a fresh kali VM I will start by setting up wireshark for my analysis.
first I start by removing columns that are not needed such as No. and Length
I then change the time display format to UTC date and time of day and seconds
I then add the columns source port and destination port.


I will now start my analysis:
first I open statistics protocol hierarchy her is see that 98% of traffic in this pcap originates from IPv4 and most of that 96% is from tcp and 70% of transsmitted bytes originate from HTTP.

Lets take a further look at HTTP:
I do this by right clicking on HTTP and applying it as a filter I then change the  filter from "http" to "http.request or ssl.handshake == 1"  though seeing as there isn't much visible ssl traffic in this PCAP I remove the SSL handshake part.

Then to make it easier on myself I add an another column this time a custom one by going to Hypertext transfer protocol  clicking to open the dropdown and scrolling to the HOST line right clicking it and choosing "Apply as Column"

I now see that the host 172.16.165.165 is the only one in this PCAP that has had any http communication probably making this the infected host for which we should find out the hostname and MAC address
we can find both by filtering for dhcp 
the MAC; is f0:19:af:02:9b:f1
and the hostname is; K34EN6W3N-PC

In case of a company device now might be the time to at least temporarily isolate it from the network.

I sort by time and we can see that bing.com is the first host/domain name 
in the plaintext view we can see that the host searched bing for ciniholland.nl
and we can see that the host viewed the ciniholland website with bing as a referrer
which we can also add as a column just like we did earlier and we can then see something very interesting.

The ciniholland landing page: "ciniholland.nl/\r\n"
refers to quite suspicious looking hostnames: "adultbiz.in" and 
"24corp-shop.com" which in turn redirects to "stand.trustandprobaterealty.com"

let us now take a look at the objcts we can export we do this by going to File and then export objects HTTP, this time lets sort by contennt type.

We can now see 3 distinct suspicious files a JAR an EXE and a SFW all distributed by "stand.trustandprobaterealty.com"
let us save these files and hash these files so we can compare thm to a database like VirusTotal either SHA-256 or MD5 will work for this application.
and let us also save the html from the ciniholland index page to study.

heres a list of the hashes of the files:
JAR: 178be0ed83a7a9020121dee1c305fd6ca3b74d15836835cfb1684da0b44190d3
EXE: ce5d1c41f6ca739f6c69f175a8f688334df2ea4d2e0fb5e3243ae01efd251e81
SFW: e2e33b802a0d939d07bd8291f23484c2f68ccc33dc0655eb4493e5d3aebc0747

Now lets go to VirusTotal and compare these hashes against known threats
The JAR is marked as malicious making use of cve-2012-0507
The EXE comes up as clean but this might still be a 0day
The SFW is marked as malicious making use of cve-2014-0569

Now lets take a look at the html we saved previously:
lets search for the domains it redirects to,
at the bottom of the html seemingly appended we find a hidden iframe mentioning 24corp and a script mentioning adultbiz

Increasing the likelihood this was a benign website that was hacked in order to drop a malicious payload marking the domains after as likely being under full control of the attackers.

www.ciniholland.nl IP: 82.150.140.30 >
24corp-shop.com IP: 188.225.73.100 >
stand.trustandprobaterealty.com IP: 37.200.69.143

lets also save the HTML of 24corp and trustandprobaterealty and take a look at those
24corp only seems to redirect to trustandprobaterealty making it redirect to the dropper
the dropper trustandprobaterealty is much more interesting lets submit it to VirusTotal.

Here we can confirm that this is indeed a dropper detecting: Exploit:JS/Meadgive.P






Now let us answer the questions on the exercise page:

LEVEL 1 QUESTIONS:

1) What is the IP address of the Windows VM that gets infected?
    172.16.165.165
2) What is the host name of the Windows VM that gets infected?
    K34EN6W3N-PC
3) What is the MAC address of the infected VM?
    f0:19:af:02:9b:f1

4) What is the IP address of the compromised web site?
    82.150.140.30
5) What is the domain name of the compromised web site?
    www.ciniholland.nl
6) What is the IP address and domain name that delivered the exploit kit and malware?
    37.200.69.143
7) What is the domain name that delivered the exploit kit and malware?
    stand.trustandprobaterealty.com



LEVEL 2 QUESTIONS:

1) What is the redirect URL that points to the exploit kit (EK) landing page?
    24corp-shop.com
2) Besides the landing page (which contains the CVE-2013-2551 IE exploit), what other exploit(s) sent by the EK?
    I missed the IE exploit but the other 2 are the Java and Flash exploits

4) How many times was the payload delivered?
    from looking at the export I would say 2/3 times

5) Submit the pcap to VirusTotal and find out what snort alerts triggered.  What are the EK names are shown in the Suricata alerts?
    ET CURRENT_EVENTS GoonEK encrypted binary (3) [2018297]
    ET CURRENT_EVENTS Goon/Infinity URI Struct EK Landing May 05 2014 [2018441]
    ET CURRENT_EVENTS RIG EK Landing URI Struct [2019072]


LEVEL 3 QUESTIONS:

1) Checking my website, what have I (and others) been calling this exploit kit?
    Rig EK

2) What file or page from the compromised website has the malicious script with the URL for the redirect?
    The index page of ciniholland.nl redirects to 24corp-shop.com

3) Extract the exploit file(s).  What is(are) the md5 file hash(es)? 
    JAR Exploit: 1e34fdebbf655cebea78b45e43520ddf
    SFW Exploit: 7b3baa7d6bb3720f369219789e38d6ab

4) VirusTotal doesn't show all the VRT rules under the "Snort alerts" section for the pcap analysis.  If you run your own version of Snort with the VRT ruleset as a registered user (or a subscriber), what VRT rules fire?
    N/A not currently running my own snort
